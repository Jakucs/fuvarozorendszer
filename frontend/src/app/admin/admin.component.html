<div class="container mt-5">
  <h2 class="text-center mb-4">Fuvarfeladatok kezelése</h2>

    <!-- Értesítés ikon -->
    <div class="position-fixed top-0 end-0 m-3 me-5">
      <button
        class="btn btn-outline-secondary position-relative"
        (click)="toggleNotifications()"
      >
        <i class="bi bi-bell"></i>
        <span
          *ngIf="hasNewNotifications"
          class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"
        ></span>
      </button>

      <!-- Legördülő értesítések panel -->
      <div
        *ngIf="showNotifications"
        class="card shadow position-absolute end-0 mt-2"
        style="width: 250px; z-index: 1050;"
      >
        <div class="card-header bg-light fw-bold">Értesítések</div>
        <ul class="list-group list-group-flush">
          <li *ngFor="let n of notifications" class="list-group-item small">
            {{ n.message }}
          </li>
          <li *ngIf="notifications.length === 0" class="list-group-item text-muted small text-center">
            Nincs új értesítés
          </li>
        </ul>
      </div>
    </div>


  
  <div class="card p-4 mb-4 shadow-sm">
    <h4>Új munka létrehozása</h4>
    <form (ngSubmit)="createDelivery()" #createForm="ngForm" class="mt-3">

      <div class="mb-3">
        <label class="form-label">Kiindulási cím</label>
        <input
          type="text"
          class="form-control"
          name="pickup_address"
          [(ngModel)]="newDelivery.pickup_address"
          required
        />
      </div>
      <div class="mb-3">
        <label class="form-label">Érkezési cím</label>
        <input
          type="text"
          class="form-control"
          name="delivery_address"
          [(ngModel)]="newDelivery.delivery_address"
          required
        />
      </div>
      <div class="mb-3">
        <label class="form-label">Címzett neve</label>
        <input
          type="text"
          class="form-control"
          name="recipient_name"
          [(ngModel)]="newDelivery.recipient_name"
          required
        />
      </div>
      <div class="mb-3">
        <label class="form-label">Címzett elérhetősége</label>
        <input
          type="text"
          class="form-control"
          name="recipient_phone"
          [(ngModel)]="newDelivery.recipient_phone"
          required
        />
      </div>


      <div class="mb-3">
        <label class="form-label">Fuvarozó</label>
        <div class="input-group">
          <select
            class="form-control"
            name="carrier_id"
            [(ngModel)]="newDelivery.carrier_id"
            required
          >
            <option value="" disabled selected>Válassz fuvarozót...</option>
            <option *ngFor="let carrier of carriers" [value]="carrier.id">
              {{ carrier.name }}
            </option>
          </select>
          <!--<button
            class="btn btn-outline-secondary"
            type="button"
            (click)="toggleNewCarrier()"
          >
            Új
          </button> -->
        </div>
      </div>

      <!-- Új fuvarozó űrlap -->
      <!--<div *ngIf="showNewCarrier" class="mb-3 mt-2 border rounded p-3 bg-light">
        <label class="form-label">Új fuvarozó neve</label>
        <input
          type="text"
          class="form-control mb-2"
          [(ngModel)]="newCarrierName"
          name="newCarrierName"
          placeholder="Pl.: Kiss Trans Kft."
        />
        <button class="btn btn-success btn-sm" type="button" (click)="addCarrier()">
          Hozzáadás
        </button>

      </div> -->


      <button class="btn btn-success w-100" [disabled]="createForm.invalid">
        Létrehozás
      </button>
    </form>
  </div>

  
  <div class="card p-4 shadow-sm">
    <h4>Meglévő fuvarok</h4>

      <!-- SZŰRŐ DROPDOWN -->
  <div class="mb-3">
    <label for="statusFilter" class="form-label">Szűrés státusz alapján:</label>
    <select
      id="statusFilter"
      class="form-select"
      [(ngModel)]="selectedStatus"
      (change)="onStatusFilterChange()"
    >
      <option value="">Összes</option>
      <option value="Kiosztva">Kiosztva</option>
      <option value="Folyamatban">Folyamatban</option>
      <option value="Elvégezvve">Elvégezve</option>
      <option value="Törölve">Törölve</option>
    </select>
  </div>

    <div *ngIf="deliveries.length === 0" class="text-muted text-center mt-3">
      Nincs még fuvarfeladat.
    </div>

    <div *ngFor="let d of deliveries" class="border rounded p-3 my-2">
      <p><strong>Kiindulás:</strong> {{ d.pickup_address }}</p>
      <p><strong>Érkezés:</strong> {{ d.delivery_address }}</p>
      <p><strong>Címzett:</strong> {{ d.recipient_name }}</p>
      <p><strong>Elérhetőség:</strong> {{ d.recipient_phone }}</p>
      <p><strong>Fuvarozó:</strong> {{ d.carrier?.name || 'Nincs hozzárendelve' }}</p>
      <p><strong>Státusz:</strong> {{ d.status }}</p>


      <div class="d-flex gap-2">
        <!-- Teljes módosítás menü megnyitása -->
        <button class="btn btn-primary btn-sm" (click)="d.showEdit = !d.showEdit">
          Módosítás
        </button>
        <button class="btn btn-danger btn-sm" (click)="deleteDelivery(d.id)">
          Törlés
        </button>
      </div>

      <!-- Teljes szerkesztő menü -->
      <div *ngIf="d.showEdit" class="mt-2 border-top pt-2">
        <div class="mb-1">
          <label><strong>Kiindulás:</strong></label>
          <input type="text" [(ngModel)]="d.pickup_address" class="form-control" />
        </div>

        <div class="mb-1">
          <label><strong>Érkezés:</strong></label>
          <input type="text" [(ngModel)]="d.delivery_address" class="form-control" />
        </div>

        <div class="mb-1">
          <label><strong>Címzett:</strong></label>
          <input type="text" [(ngModel)]="d.recipient_name" class="form-control" />
        </div>

        <div class="mb-1">
          <label><strong>Elérhetőség:</strong></label>
          <input type="text" [(ngModel)]="d.recipient_phone" class="form-control" />
        </div>

        <div class="mb-1">
          <label><strong>Fuvarozó:</strong></label>
          <select class="form-control" [(ngModel)]="d.carrier_id">
            <option [ngValue]="null">Nincs hozzárendelve</option>
            <option *ngFor="let carrier of carriers" [ngValue]="carrier.id">{{ carrier.name }}</option>
          </select>
        </div>

        <div class="d-flex gap-2 mt-1">
          <button class="btn btn-success btn-sm" (click)="updateDelivery(d)">Mentés</button>
          <button class="btn btn-secondary btn-sm" (click)="d.showEdit = false">Mégse</button>
        </div>
      </div>
  </div>

  <p *ngIf="successMessage" class="text-success mt-3 text-center">
    {{ successMessage }}
  </p>
  <p *ngIf="errorMessage" class="text-danger mt-3 text-center">
    {{ errorMessage }}
  </p>
</div>

<button 
  class="btn btn-outline-danger position-fixed top-0 start-0 m-3"
  (click)="logout()"
>
  Kilépés
</button>